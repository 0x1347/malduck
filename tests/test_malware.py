import base64

from malduck import procmem, procmempe
from malduck.compression.aplib import aPLib


def test_mal1():
    with open("tests/files/mal1.b64") as f:
        mal1 = base64.b64decode(f.read())

    # Load dumped image
    ppe = procmempe(mal1)
    # Decompress payload
    payload = aPLib().decompress(
        ppe.readv(ppe.imgbase + 0x8400, ppe.imgend)
    )
    embed_pe = procmem(payload, base=0)
    # Fix headers
    embed_pe.patchp(0, "MZ")
    embed_pe.patchp(embed_pe.uint32p(0x3C), "PE")
    # Load patched image into procmempe
    embed_pe = procmempe.from_memory(embed_pe, image=True)
    assert embed_pe.asciiz(0x1000a410) == "StrToIntExA"
